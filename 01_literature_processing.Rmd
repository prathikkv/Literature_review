---
title: "CAMK2D Literature Analysis for Cardiac Research"
author: "CAMK2D Research Consortium"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: hide
    df_print: paged
  pdf_document:
    toc: true
params:
  focus_area: "both"  # "aFIB", "HF", or "both" - aligned with dataset discovery
  expand_literature: TRUE  # Use expanded literature search
  cross_reference_datasets: TRUE  # Cross-reference with discovered datasets
  output_dir: "output"
  generate_excel: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 12,
  fig.height = 8,
  dpi = 300
)

# Load required libraries
suppressPackageStartupMessages({
  library(tidyverse)
  library(plotly)
  library(openxlsx)
  library(DT)
  library(scales)
  library(viridis)
  library(knitr)
  library(kableExtra)
})

# Load specialized functions
source("functions/targeted_camk2d_search.R")
# Note: pubmed_literature_search.R removed during cleanup

# Create output directory
if (!dir.exists(params$output_dir)) {
  dir.create(params$output_dir, recursive = TRUE)
}
```

# Executive Summary

This document provides **targeted CAMK2D literature analysis** specifically aligned with our research proposal focusing on:

- **Primary Objective**: CAMK2D role in atrial fibrillation (aFIB) and heart failure (HF)
- **Literature Integration**: Cross-referenced with dataset discovery findings
- **Evidence Synthesis**: Literature supports dataset selection and interpretation
- **Proposal Alignment**: Directly supports Activity 1 and Activity 2 objectives

**Key Enhancement**: This literature analysis is now **integrated with dataset discovery** to provide coherent evidence supporting your specific research objectives.

# 1. Research Focus Configuration

## 1.1 Literature Analysis Parameters

```{r parameters}
cat("üìö CAMK2D Literature Analysis Configuration\n")
cat("===========================================\n")
cat("Focus Area:", params$focus_area, "\n")
cat("Expand Literature Search:", params$expand_literature, "\n")
cat("Cross-Reference with Datasets:", params$cross_reference_datasets, "\n")
cat("Generate Excel Reports:", params$generate_excel, "\n\n")

# Display alignment with research objectives
objectives_table <- data.frame(
  Research_Activity = c(
    "Activity 1: CAMK2D role in aFIB",
    "Activity 1: CAMK2D role in HF",
    "Activity 1: Inhibitor response evidence",
    "Activity 1: Phosphorylation substrates",
    "Activity 2: Expression evidence",
    "Cross-reference with datasets"
  ),
  Literature_Support = c(
    ifelse(params$focus_area %in% c("aFIB", "both"), "‚úÖ Targeted Search", "‚ö†Ô∏è Limited"),
    ifelse(params$focus_area %in% c("HF", "both"), "‚úÖ Targeted Search", "‚ö†Ô∏è Limited"),
    "‚úÖ Inhibitor Studies Included",
    "‚úÖ Substrate Studies Included", 
    "‚úÖ Expression Studies Prioritized",
    ifelse(params$cross_reference_datasets, "‚úÖ Enabled", "‚ùå Disabled")
  )
)

kable(objectives_table, caption = "Literature Analysis Alignment with Research Objectives") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

# 2. Literature Data Acquisition

## 2.1 Targeted Literature Discovery

```{r literature-acquisition}
cat("üìñ Acquiring CAMK2D literature aligned with dataset discovery strategy...\n\n")

# Load base literature data
base_literature_file <- "data/real_camk2d_literature.csv"
literature_data <- NULL

if (file.exists(base_literature_file)) {
  base_literature <- read_csv(base_literature_file, show_col_types = FALSE)
  cat("‚úÖ Loaded", nrow(base_literature), "base CAMK2D literature papers\n")
  literature_data <- base_literature
} else {
  cat("‚ö†Ô∏è Base literature file not found, starting with empty dataset\n")
  literature_data <- data.frame()
}

# Expand literature search if enabled
if (params$expand_literature) {
  cat("üîç Expanding literature search with targeted strategies...\n")
  
  # Load expanded literature (now available)
  expanded_literature_file <- "data/comprehensive_camk2d_literature.csv"
  
  if (file.exists(expanded_literature_file)) {
    expanded_literature <- read_csv(expanded_literature_file, show_col_types = FALSE)
    cat("‚úÖ Loaded", nrow(expanded_literature), "papers from expanded literature collection\n")
    
    # Filter for proposal-relevant literature
    if (nrow(expanded_literature) > 0) {
      relevant_literature <- expanded_literature %>%
        filter(
          # Focus on CAMK2D specifically
          CAMK_Member == "CAMK2D" |
          # Include aFIB studies if in focus
          (params$focus_area %in% c("aFIB", "both") & Disease == "aFIB") |
          # Include HF studies if in focus  
          (params$focus_area %in% c("HF", "both") & Disease %in% c("Heart_Failure", "Heart_Disease")) |
          # Include inhibitor/substrate studies
          grepl("inhibit|substrat|phosphor", Main_Finding, ignore.case = TRUE)
        )
      
      if (nrow(literature_data) > 0) {
        literature_data <- bind_rows(literature_data, relevant_literature) %>%
          distinct(PMID, .keep_all = TRUE)  # Remove duplicates by PMID
      } else {
        literature_data <- relevant_literature
      }
      
      cat("üìä Filtered to", nrow(relevant_literature), "proposal-relevant papers\n")
    }
  } else {
    cat("‚ö†Ô∏è Expanded literature file not found - consider running literature expansion\n")
  }
}

if (nrow(literature_data) == 0) {
  cat("‚ùå No literature data available for analysis\n")
  stop("Please ensure literature data is available or run literature expansion")
}

cat("\nüìö Final Literature Dataset:\n")
cat("   Total papers:", nrow(literature_data), "\n")
cat("   CAMK2D papers:", sum(literature_data$CAMK_Member == "CAMK2D", na.rm = TRUE), "\n")
cat("   aFIB papers:", sum(literature_data$Disease == "aFIB", na.rm = TRUE), "\n")
cat("   HF papers:", sum(literature_data$Disease %in% c("Heart_Failure", "Heart_Disease"), na.rm = TRUE), "\n")
cat("   Year range:", min(literature_data$Year, na.rm = TRUE), "-", max(literature_data$Year, na.rm = TRUE), "\n\n")
```

## 2.2 Literature Quality Assessment

```{r literature-quality}
if (nrow(literature_data) > 0) {
  
  cat("üìä Assessing literature quality with proposal-specific criteria...\n")
  
  # Enhanced quality scoring aligned with research objectives
  literature_data <- literature_data %>%
    mutate(
      # CAMK2D relevance score
      CAMK2D_Relevance_Score = case_when(
        CAMK_Member == "CAMK2D" ~ 10,
        grepl("CAMK2D|CaMKII.*delta", Main_Finding, ignore.case = TRUE) ~ 8,
        grepl("CaMKII|calmodulin.*kinase", Main_Finding, ignore.case = TRUE) ~ 6,
        TRUE ~ 3
      ),
      
      # Disease relevance score (proposal-aligned)
      Disease_Relevance_Score = case_when(
        Disease == "aFIB" & params$focus_area %in% c("aFIB", "both") ~ 10,
        Disease %in% c("Heart_Failure", "Heart_Disease") & params$focus_area %in% c("HF", "both") ~ 10,
        Disease %in% c("Arrhythmia", "Cardiomyopathy") ~ 8,
        Disease %in% c("General_Cardiac", "Other_Cardiac") ~ 6,
        TRUE ~ 3
      ),
      
      # Study type relevance
      Study_Type_Score = case_when(
        Study_Type == "Clinical" ~ 10,  # Highest priority for translation
        Study_Type == "Animal" ~ 8,    # Good for mechanistic insights
        Study_Type == "Review" ~ 6,    # Useful for background
        Study_Type == "Cell" ~ 5,      # Mechanistic but limited
        TRUE ~ 3
      ),
      
      # Evidence strength score
      Evidence_Score = case_when(
        !is.na(P_Value) & P_Value < 0.01 ~ 10,
        !is.na(P_Value) & P_Value < 0.05 ~ 8,
        !is.na(Effect_Size) & abs(Effect_Size) > 2 ~ 8,
        !is.na(Effect_Size) & abs(Effect_Size) > 1.5 ~ 6,
        !is.na(Sample_Size) & Sample_Size >= 50 ~ 8,
        !is.na(Sample_Size) & Sample_Size >= 20 ~ 6,
        TRUE ~ 4
      ),
      
      # Total quality score (proposal-aligned)
      Total_Quality_Score = CAMK2D_Relevance_Score + Disease_Relevance_Score + 
                           Study_Type_Score + Evidence_Score,
      
      # Quality category with robust handling
      Quality_Category = case_when(
        Total_Quality_Score >= 35 ~ "Excellent",
        Total_Quality_Score >= 30 ~ "High", 
        Total_Quality_Score >= 20 ~ "Medium",
        TRUE ~ "Low"
      ),
      
      # Proposal relevance category
      Proposal_Relevance = case_when(
        CAMK2D_Relevance_Score >= 8 & Disease_Relevance_Score >= 8 ~ "High Relevance",
        CAMK2D_Relevance_Score >= 6 | Disease_Relevance_Score >= 8 ~ "Medium Relevance", 
        TRUE ~ "Low Relevance"
      )
    )
  
  # Display quality distribution with enhanced error handling
  cat("üìä Quality Assessment Results:\n")
  cat("   Total papers scored:", nrow(literature_data), "\n")
  cat("   Quality categories:", paste(unique(literature_data$Quality_Category), collapse = ", "), "\n")
  cat("   Proposal relevance:", paste(unique(literature_data$Proposal_Relevance), collapse = ", "), "\n\n")
  
  # Try to create cross-tabulation
  tryCatch({
    if ("Quality_Category" %in% names(literature_data) && "Proposal_Relevance" %in% names(literature_data)) {
      quality_summary <- literature_data %>%
        count(Quality_Category, Proposal_Relevance, .drop = FALSE) %>%
        pivot_wider(names_from = Proposal_Relevance, values_from = n, values_fill = 0)
      
      kable(quality_summary, 
            caption = "Literature Quality and Proposal Relevance Distribution") %>%
        kable_styling(bootstrap_options = c("striped", "hover"))
    } else {
      stop("Required columns not found")
    }
  }, error = function(e) {
    cat("‚ö†Ô∏è Cross-tabulation failed, showing simple summaries:\n")
    
    # Show quality distribution
    if ("Quality_Category" %in% names(literature_data)) {
      quality_simple <- table(literature_data$Quality_Category)
      cat("Quality Distribution:\n")
      print(quality_simple)
    }
    
    # Show relevance distribution  
    if ("Proposal_Relevance" %in% names(literature_data)) {
      relevance_simple <- table(literature_data$Proposal_Relevance)
      cat("Relevance Distribution:\n")
      print(relevance_simple)
    }
  })
}
```

# 3. Cross-Reference with Dataset Discovery

## 3.1 Literature-Dataset Integration

```{r cross-reference-datasets}
if (params$cross_reference_datasets && nrow(literature_data) > 0) {
  
  cat("üîó Cross-referencing literature with discovered datasets...\n\n")
  
  # Check if dataset discovery results exist
  dataset_files <- list.files(params$output_dir, pattern = "CAMK2D.*Discovery.*csv", full.names = TRUE)
  
  if (length(dataset_files) > 0) {
    # Load most recent dataset discovery results
    latest_dataset_file <- dataset_files[which.max(file.mtime(dataset_files))]
    discovered_datasets <- read_csv(latest_dataset_file, show_col_types = FALSE)
    
    cat("‚úÖ Loaded", nrow(discovered_datasets), "discovered datasets from:", basename(latest_dataset_file), "\n")
    
    # Extract PMIDs from datasets where available
    dataset_pmids <- discovered_datasets %>%
      filter(!is.na(PubMed_ID) & PubMed_ID != "" & PubMed_ID != "NA") %>%
      mutate(PMID_clean = str_extract(PubMed_ID, "\\d+")) %>%
      filter(!is.na(PMID_clean))
    
    if (nrow(dataset_pmids) > 0) {
      cat("üìñ Found", nrow(dataset_pmids), "datasets with PMIDs for cross-referencing\n")
      
      # Cross-reference literature PMIDs with dataset PMIDs
      literature_data <- literature_data %>%
        mutate(
          PMID_str = as.character(PMID),
          Supporting_Dataset = PMID_str %in% dataset_pmids$PMID_clean,
          Dataset_Accession = ifelse(Supporting_Dataset,
                                   dataset_pmids$GEO_Accession[match(PMID_str, dataset_pmids$PMID_clean)],
                                   NA)
        )
      
      supported_papers <- sum(literature_data$Supporting_Dataset, na.rm = TRUE)
      cat("üî¨ Found", supported_papers, "literature papers with supporting expression datasets\n")
      
      if (supported_papers > 0) {
        # Display cross-referenced papers
        cross_ref_summary <- literature_data %>%
          filter(Supporting_Dataset == TRUE) %>%
          dplyr::select(PMID, Authors, Year, Disease, Main_Finding, Dataset_Accession) %>%
          head(10)
        
        kable(cross_ref_summary,
              caption = "Literature Papers with Supporting Expression Datasets",
              col.names = c("PMID", "Authors", "Year", "Disease", "Finding", "GEO Dataset")) %>%
          kable_styling(bootstrap_options = c("striped", "hover"), font_size = 10) %>%
          scroll_box(width = "100%")
      }
    } else {
      cat("‚ö†Ô∏è No PMIDs found in discovered datasets for cross-referencing\n")
      literature_data$Supporting_Dataset <- FALSE
      literature_data$Dataset_Accession <- NA
    }
    
  } else {
    cat("‚ö†Ô∏è No dataset discovery results found - run dataset discovery first\n")
    literature_data$Supporting_Dataset <- FALSE
    literature_data$Dataset_Accession <- NA
  }
} else {
  literature_data$Supporting_Dataset <- FALSE
  literature_data$Dataset_Accession <- NA
}
```

# 4. CAMK2D Evidence Analysis

## 4.1 CAMK2D Role in Cardiac Disease

```{r camk2d-evidence-analysis}
if (nrow(literature_data) > 0) {
  
  cat("üß¨ Analyzing CAMK2D evidence by disease category...\n\n")
  
  # Activity 1 Analysis: CAMK2D characterization
  camk2d_evidence <- literature_data %>%
    filter(CAMK_Member == "CAMK2D" | grepl("CAMK2D", Main_Finding, ignore.case = TRUE))
  
  if (nrow(camk2d_evidence) > 0) {
    
    # Disease-specific evidence
    disease_evidence <- camk2d_evidence %>%
      group_by(Disease, Study_Type) %>%
      summarise(
        Papers = n(),
        Avg_Effect_Size = round(mean(Effect_Size, na.rm = TRUE), 2),
        Significant_Studies = sum(!is.na(P_Value) & P_Value < 0.05, na.rm = TRUE),
        With_Datasets = sum(Supporting_Dataset, na.rm = TRUE),
        Avg_Quality = round(mean(Total_Quality_Score, na.rm = TRUE), 1),
        .groups = "drop"
      ) %>%
      arrange(desc(Papers))
    
    kable(disease_evidence,
          caption = "CAMK2D Evidence Summary by Disease and Study Type",
          col.names = c("Disease", "Study Type", "Papers", "Avg Effect", 
                       "Significant", "With Datasets", "Avg Quality")) %>%
      kable_styling(bootstrap_options = c("striped", "hover"))
    
    # Focus area analysis
    if (params$focus_area == "aFIB" || params$focus_area == "both") {
      afib_evidence <- camk2d_evidence %>%
        filter(Disease == "aFIB") %>%
        dplyr::select(Authors, Year, Study_Type, Main_Finding, Effect_Size, P_Value, Supporting_Dataset)
      
      if (nrow(afib_evidence) > 0) {
        cat("\nü´Ä CAMK2D in Atrial Fibrillation Evidence:\n")
        kable(head(afib_evidence, 5),
              caption = "Top CAMK2D aFIB Studies",
              col.names = c("Authors", "Year", "Type", "Finding", "Effect", "P-value", "Has Dataset")) %>%
          kable_styling(bootstrap_options = c("striped", "hover"), font_size = 9) %>%
          scroll_box(width = "100%")
      }
    }
    
    if (params$focus_area == "HF" || params$focus_area == "both") {
      hf_evidence <- camk2d_evidence %>%
        filter(Disease %in% c("Heart_Failure", "Heart_Disease", "Cardiomyopathy")) %>%
        dplyr::select(Authors, Year, Study_Type, Main_Finding, Effect_Size, P_Value, Supporting_Dataset)
      
      if (nrow(hf_evidence) > 0) {
        cat("\nüíî CAMK2D in Heart Failure Evidence:\n")
        kable(head(hf_evidence, 5),
              caption = "Top CAMK2D Heart Failure Studies",
              col.names = c("Authors", "Year", "Type", "Finding", "Effect", "P-value", "Has Dataset")) %>%
          kable_styling(bootstrap_options = c("striped", "hover"), font_size = 9) %>%
          scroll_box(width = "100%")
      }
    }
  }
}
```

## 4.2 Inhibitor and Substrate Evidence

```{r inhibitor-substrate-analysis}
if (nrow(literature_data) > 0) {
  
  cat("üíä Analyzing CAMK2D inhibitor and substrate evidence...\n\n")
  
  # Inhibitor evidence (Activity 1 requirement)
  inhibitor_evidence <- literature_data %>%
    filter(grepl("inhibit|block|antagonist|KN-93|AIP|silenc", Main_Finding, ignore.case = TRUE))
  
  if (nrow(inhibitor_evidence) > 0) {
    inhibitor_summary <- inhibitor_evidence %>%
      group_by(Disease, Study_Type) %>%
      summarise(
        Studies = n(),
        Avg_Effect = round(mean(Effect_Size, na.rm = TRUE), 2),
        Significant = sum(!is.na(P_Value) & P_Value < 0.05, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      arrange(desc(Studies))
    
    kable(inhibitor_summary,
          caption = "CAMK2D Inhibitor Evidence by Disease",
          col.names = c("Disease", "Study Type", "Studies", "Avg Effect", "Significant")) %>%
      kable_styling(bootstrap_options = c("striped", "hover"))
  }
  
  # Substrate/phosphorylation evidence (Activity 1 requirement)
  substrate_evidence <- literature_data %>%
    filter(grepl("substrat|phosphor|target|phosphorylat", Main_Finding, ignore.case = TRUE))
  
  if (nrow(substrate_evidence) > 0) {
    substrate_summary <- substrate_evidence %>%
      group_by(Disease, Study_Type) %>%
      summarise(
        Studies = n(),
        With_Datasets = sum(Supporting_Dataset, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      arrange(desc(Studies))
    
    kable(substrate_summary,
          caption = "CAMK2D Substrate/Phosphorylation Evidence",
          col.names = c("Disease", "Study Type", "Studies", "With Expression Data")) %>%
      kable_styling(bootstrap_options = c("striped", "hover"))
  }
}
```

# 5. Evidence Synthesis and Integration

## 5.1 Literature-Dataset Evidence Matrix

```{r evidence-matrix}
if (nrow(literature_data) > 0) {
  
  cat("üî¨ Creating evidence matrix linking literature with datasets...\n")
  
  # Create comprehensive evidence matrix
  evidence_matrix <- literature_data %>%
    filter(Proposal_Relevance %in% c("High Relevance", "Medium Relevance")) %>%
    group_by(Disease, Study_Type) %>%
    summarise(
      Literature_Papers = n(),
      Avg_Quality_Score = round(mean(Total_Quality_Score, na.rm = TRUE), 1),
      Papers_With_Datasets = sum(Supporting_Dataset, na.rm = TRUE),
      Expression_Coverage = round(Papers_With_Datasets / Literature_Papers * 100, 1),
      Significant_Findings = sum(!is.na(P_Value) & P_Value < 0.05, na.rm = TRUE),
      Evidence_Strength = case_when(
        Papers_With_Datasets >= 2 & Significant_Findings >= 1 ~ "Strong",
        Papers_With_Datasets >= 1 | Significant_Findings >= 2 ~ "Moderate", 
        Literature_Papers >= 3 ~ "Moderate",
        TRUE ~ "Limited"
      ),
      .groups = "drop"
    ) %>%
    arrange(desc(Literature_Papers))
  
  kable(evidence_matrix,
        caption = "Integrated Literature-Dataset Evidence Matrix",
        col.names = c("Disease", "Study Type", "Literature", "Avg Quality",
                     "With Datasets", "Expression Coverage %", "Significant", "Strength")) %>%
    kable_styling(bootstrap_options = c("striped", "hover"))
  
  # Research priority recommendations
  research_priorities <- evidence_matrix %>%
    mutate(
      Research_Priority = case_when(
        Evidence_Strength == "Strong" & Expression_Coverage >= 50 ~ "Immediate Analysis",
        Evidence_Strength == "Strong" ~ "High Priority",
        Evidence_Strength == "Moderate" & Literature_Papers >= 5 ~ "Medium Priority",
        TRUE ~ "Future Investigation"
      )
    ) %>%
    count(Research_Priority, name = "Disease_Areas") %>%
    arrange(match(Research_Priority, c("Immediate Analysis", "High Priority", "Medium Priority", "Future Investigation")))
  
  kable(research_priorities,
        caption = "Research Priority Assessment",
        col.names = c("Priority Level", "Disease Areas")) %>%
    kable_styling(bootstrap_options = c("striped", "hover"))
}
```

# 6. Visualization and Analysis

## 6.1 Evidence Landscape Visualization

```{r evidence-visualization}
if (nrow(literature_data) > 0) {
  
  # Evidence strength by disease and study type
  evidence_plot <- literature_data %>%
    filter(!is.na(Total_Quality_Score)) %>%
    ggplot(aes(x = Disease, y = Total_Quality_Score, 
               color = Study_Type, size = ifelse(Supporting_Dataset, 3, 1))) +
    geom_jitter(alpha = 0.7, width = 0.3) +
    scale_color_viridis_d(name = "Study Type") +
    scale_size_identity() +
    labs(
      title = "CAMK2D Literature Evidence Landscape",
      subtitle = "Large points indicate studies with supporting expression datasets",
      x = "Disease Category",
      y = "Literature Quality Score"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  print(evidence_plot)
  
  # Timeline of research development
  if (nrow(literature_data) >= 10) {
    timeline_plot <- literature_data %>%
      filter(Year >= 2000) %>%
      count(Year, Disease) %>%
      ggplot(aes(x = Year, y = n, fill = Disease)) +
      geom_area(alpha = 0.7) +
      scale_fill_viridis_d(name = "Disease") +
      labs(
        title = "CAMK2D Research Timeline by Disease",
        subtitle = "Growth of research evidence over time",
        x = "Year",
        y = "Number of Papers"
      ) +
      theme_minimal()
    
    print(timeline_plot)
  }
}
```

# 7. Export and Integration

## 7.1 Comprehensive Results Export

```{r export-literature-results}
if (params$generate_excel && nrow(literature_data) > 0) {
  
  cat("üìä Exporting integrated literature analysis...\n")
  
  # Create comprehensive Excel report
  wb <- createWorkbook()
  
  # Sheet 1: Complete literature analysis
  addWorksheet(wb, "Literature_Analysis")
  writeData(wb, "Literature_Analysis", literature_data)
  
  # Sheet 2: Evidence matrix
  if (exists("evidence_matrix")) {
    addWorksheet(wb, "Evidence_Matrix")
    writeData(wb, "Evidence_Matrix", evidence_matrix)
  }
  
  # Sheet 3: High-quality studies
  high_quality_studies <- literature_data %>%
    filter(Quality_Category %in% c("High", "Excellent")) %>%
    arrange(desc(Total_Quality_Score))
  
  if (nrow(high_quality_studies) > 0) {
    addWorksheet(wb, "High_Quality_Studies")
    writeData(wb, "High_Quality_Studies", high_quality_studies)
  }
  
  # Sheet 4: Studies with datasets
  studies_with_datasets <- literature_data %>%
    filter(Supporting_Dataset == TRUE) %>%
    arrange(desc(Total_Quality_Score))
  
  if (nrow(studies_with_datasets) > 0) {
    addWorksheet(wb, "Studies_With_Datasets")
    writeData(wb, "Studies_With_Datasets", studies_with_datasets)
  }
  
  # Sheet 5: Research recommendations
  recommendations_data <- data.frame(
    Recommendation = c(
      "Immediate Analysis Priority",
      "High Priority Investigation", 
      "Medium Priority Research",
      "Cross-Reference Validation",
      "Literature-Dataset Integration"
    ),
    Details = c(
      paste("Studies with strong evidence and expression datasets:", 
            sum(literature_data$Supporting_Dataset & literature_data$Quality_Category %in% c("High", "Excellent"), na.rm = TRUE)),
      paste("High-quality studies without datasets:", 
            sum(!literature_data$Supporting_Dataset & literature_data$Quality_Category %in% c("High", "Excellent"), na.rm = TRUE)),
      paste("Medium-quality studies for validation:", 
            sum(literature_data$Quality_Category == "Medium", na.rm = TRUE)),
      paste("Literature-dataset pairs for validation:", 
            sum(literature_data$Supporting_Dataset, na.rm = TRUE)),
      "Integrate findings with expression analysis results"
    )
  )
  
  addWorksheet(wb, "Research_Recommendations")
  writeData(wb, "Research_Recommendations", recommendations_data)
  
  # Save Excel file
  excel_file <- file.path(params$output_dir, 
                         paste0("CAMK2D_Literature_Analysis_", format(Sys.Date(), "%Y%m%d"), ".xlsx"))
  saveWorkbook(wb, excel_file, overwrite = TRUE)
  
  cat("‚úÖ Literature analysis exported to:", excel_file, "\n")
  
  # Also save main results as CSV
  csv_file <- file.path(params$output_dir, 
                       paste0("CAMK2D_Literature_Results_", format(Sys.Date(), "%Y%m%d"), ".csv"))
  write_csv(literature_data, csv_file)
  
  cat("‚úÖ Literature data saved to:", csv_file, "\n")
}
```

# 8. Research Integration Recommendations

## 8.1 Literature-Dataset Research Pipeline

```{r research-integration}
cat("üî¨ CAMK2D Research Integration Recommendations\n")
cat("==============================================\n\n")

if (nrow(literature_data) > 0) {
  
  # Analysis readiness assessment
  ready_for_analysis <- sum(literature_data$Supporting_Dataset, na.rm = TRUE)
  high_quality_literature <- sum(literature_data$Quality_Category %in% c("High", "Excellent"), na.rm = TRUE)
  
  cat("üìä Integration Status:\n")
  cat("‚Ä¢ Literature papers analyzed:", nrow(literature_data), "\n")
  cat("‚Ä¢ High-quality studies:", high_quality_literature, "\n")
  cat("‚Ä¢ Studies with expression datasets:", ready_for_analysis, "\n")
  cat("‚Ä¢ Literature-dataset integration rate:", round(ready_for_analysis/nrow(literature_data)*100, 1), "%\n\n")
  
  if (ready_for_analysis > 0) {
    cat("‚úÖ INTEGRATED ANALYSIS READY:\n")
    cat("1. Literature provides mechanistic context for", ready_for_analysis, "expression datasets\n")
    cat("2. Expression data validates findings from", ready_for_analysis, "literature studies\n") 
    cat("3. Cross-validated evidence strengthens research conclusions\n")
    cat("4. Integrated findings support proposal objectives directly\n\n")
    
    cat("üìã SUGGESTED INTEGRATED WORKFLOW:\n")
    cat("1. Begin with expression analysis using validated datasets\n")
    cat("2. Interpret expression patterns using literature context\n")
    cat("3. Cross-reference findings with mechanistic evidence\n")
    cat("4. Validate novel findings against literature predictions\n")
    cat("5. Identify gaps where expression data extends literature knowledge\n\n")
  }
  
  # Activity-specific recommendations
  cat("üéØ PROPOSAL ACTIVITY SUPPORT:\n")
  
  activity1_studies <- sum(literature_data$Disease %in% c("aFIB", "Heart_Failure", "Heart_Disease") & 
                          literature_data$CAMK_Member == "CAMK2D", na.rm = TRUE)
  cat("‚Ä¢ Activity 1 (CAMK2D characterization):", activity1_studies, "relevant studies\n")
  
  inhibitor_studies <- sum(grepl("inhibit|block", literature_data$Main_Finding, ignore.case = TRUE), na.rm = TRUE)
  cat("‚Ä¢ Activity 1 (Inhibitor evidence):", inhibitor_studies, "inhibitor studies\n")
  
  substrate_studies <- sum(grepl("substrat|phosphor", literature_data$Main_Finding, ignore.case = TRUE), na.rm = TRUE) 
  cat("‚Ä¢ Activity 1 (Substrate identification):", substrate_studies, "substrate studies\n")
  
  expression_studies <- sum(literature_data$Supporting_Dataset, na.rm = TRUE)
  cat("‚Ä¢ Activity 2 (Expression analysis):", expression_studies, "studies with expression data\n\n")
  
  # Final integration status
  if (ready_for_analysis >= 3) {
    cat("üöÄ SYSTEM INTEGRATION: COMPLETE\n")
    cat("Literature analysis and dataset discovery are now fully aligned\n")
    cat("Ready for integrated CAMK2D research with cross-validated evidence\n")
  } else {
    cat("‚ö†Ô∏è INTEGRATION IMPROVEMENT NEEDED:\n")
    cat("Consider expanding dataset discovery or literature search to increase overlap\n")
  }
}
```

---

# Final Summary

```{r final-summary}
cat("üìã CAMK2D Literature Analysis Summary\n") 
cat("=====================================\n")
cat("Analysis completed on:", format(Sys.Date(), "%Y-%m-%d"), "\n")
cat("Focus area:", params$focus_area, "\n") 
cat("Cross-referenced with datasets:", params$cross_reference_datasets, "\n\n")

if (exists("literature_data") && nrow(literature_data) > 0) {
  cat("üìä Key Results:\n")
  cat("‚Ä¢ Literature papers analyzed:", nrow(literature_data), "\n")
  cat("‚Ä¢ High-relevance studies:", sum(literature_data$Proposal_Relevance == "High Relevance", na.rm = TRUE), "\n")
  cat("‚Ä¢ Studies with expression datasets:", sum(literature_data$Supporting_Dataset, na.rm = TRUE), "\n")
  cat("‚Ä¢ Evidence strength: Strong in", 
      ifelse(exists("evidence_matrix"), 
             sum(evidence_matrix$Evidence_Strength == "Strong", na.rm = TRUE), 0), 
      "disease areas\n\n")
  
  cat("üéØ PROPOSAL ALIGNMENT: COMPLETE\n")
  cat("Literature analysis now fully supports dataset discovery and research objectives\n")
  cat("Next step: Begin integrated analysis using both literature context and expression data\n")
} else {
  cat("‚ö†Ô∏è No literature data available for analysis\n")
}
```

---

*Targeted CAMK2D Literature Analysis generated on `r Sys.Date()` with full integration to dataset discovery and research proposal alignment.*